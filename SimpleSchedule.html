<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Simple Schedule</title>

    <link rel='stylesheet' type='text/css' href='http://code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css'/>

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"
            integrity="sha256-eGE6blurk5sHj+rmkfsGYeKyZx3M4bG+ZlFyA7Kns7E="
            crossorigin="anonymous"></script>

  </head>
  <body>

	<p><div id="errorMessages"></div></p>

    <div id="scheduleFormControl"></div>

    <div id="scheduleForm" style="display: none;" >
      <p>
      <form id="scheduleForm" action="http://localhost:8080/cgi-bin/schedule.pl" >
        <table>
          <tr>
            <th style=" padding: 5px">DATE</th>
            <td><input id="date"><i class="glyphicon-calendar"></i></td>
          </tr>
          <tr>
            <th style=" padding: 5px">TIME</th>
            <td><input id="time" placeholder="Time"></td>
          </tr>
          <tr>
            <th style=" padding: 5px">DESC</th>
            <td><input id="desc" placeholder="Desc"></td>
          </tr>
        </table>
      </form>
      </p>
    </div>

    <p>
    <form onsubmit="return false;" > <!-- return false prevents default page re-load behavoir  -->
        <input class="searchInput" value="Initial Value" placeholder="Search">
        <button onClick="searchAppointments($(this).parent().find('.searchInput').val())">Search</button>
    </form>
    </p>

    <p><div id="appsTable"></div></p>

    <script type="text/javascript">

      function initDatePicker()
      {
        var config = {};

        config.showOn = "button";
        config.buttonImage = "http://jqueryui.com/resources/demos/datepicker/images/calendar.gif";
        // config.buttonImageOnly = true;

        $('#date').datepicker( config );
      }

      function initNewButton()
      {
        var div = $('div#scheduleFormControl');
        div.children().remove();
        var button = $('<button>');
        button.on('click',onNewButton);
        button.text('NEW');
        div.append(button);
      }

      function initFormButtons()
      {
        var div = $('div#scheduleFormControl');
        div.children().remove();

        var button = $('<button>');
        button.on('click',onAddButton);
        button.text('ADD');
        div.append(button);

        button = $('<button>');
        button.on('click',onCancelButton);
        button.text('CANCEL');
        div.append(button);
      }

      function initControls()
      {
        initDatePicker();
        initNewButton();
      }

      function showScheduleForm()
      {
        initFormButtons();
        $('div#scheduleForm').css("display","block");
        $('form#scheduleForm').submit( onFormSubmit );
      }

      function hideScheduleForm()
      {
        initNewButton();
        $('div#scheduleForm').css("display","none");
        $('div#scheduleForm').find('input').val("");
      }

      function onNewButton()
      {
        showScheduleForm();
      }

      function onAddButton()
      {
        var form = $('form#scheduleForm');
        var strDate = form.find('input#date').val();
        var strTime = form.find('input#time').val();
        var desc = form.find('input#desc').val();

        if ( isValidDate( strDate )
             && isValidTime( strTime )
             && isValidDesc( desc ) )
        {

          var date = new Date( strDate + " " + strTime );

          var currDate = new Date();

          if ( date.getTime() < currDate.getTime() )
          {
            displayError("The appoint time must be in the future.");
          }
          else
          {
            clearError();

            form.submit();
          }
        }

        hideScheduleForm();
      }

      function isValidTime( time )
      {
        if ( time == '' )
        {
          displayError("Time is required.");
          return false;
        }

        var pattern = /^(\d{1,2}):(\d\d)\s(am|AM|pm|PM)$/;
        var fields = time.match(pattern);

        if ( fields == null )
        {
          pattern = /^(\d\d):(\d\d)$/;
          fields = time.match(pattern);

          if ( fields == null )
          {
            displayError("Time format is hh:mm [am|pm].");
            return false;
          }
        }

        var hh = fields[1];
        var mm = fields[2];
        var n = ( fields.length - 1 );

        if ( n == 2 )
        {
          // 24 hour format
          if ( hh > 24 )
          {
            displayError("Hours is invalid. Expected 1-24.");
            return false;
          }
        }
        else // if ( n == 3 )
        {
          // 12 hour format
          if ( hh > 12 )
          {
            displayError("Hours is invalid. Expected 1-12.");
            return false;
          }
        }

        if ( mm > 60 )
        {
           displayError("Minutes is invalid. Expected 1-60.");
           return false;
        }

        return true;
      }

      function isValidDate( date )
      {
        if ( date == '' )
        {
          displayError("Date is required.");
          return false;
        }

        var pattern = /^(\d{1,2})(\/|-)(\d{1,2})(\/|-)(\d{4})$/;
        var fields = date.match(pattern);

        if ( fields == null )
        {
          displayError("Date format is mm/dd/yyyy.");
          return false;
        }

        var month = fields[1];
        var day = fields[3];
        var year = fields[5];

        if ( month > 12 )
        {
          displayError("Month is invalid. Expected 1-12.");
          return false;
        }
        else if ( month == 2 )
        {
          var isleap = ( year % 4 == 0 && ( year % 100 != 0 || year % 400 == 0 ));

          if ( isleap )
          {
            if ( day > 29 )
            {
              displayError("Day is invalid for February " + year + ". Expected 1-29.");
              return false;
            }
          }
          else if ( day > 28 )
          {
            displayError("Day is invalid for February " + year + ". Expected 1-28.");
            return false;
          }
        }
        else
        {
          var daysPerMonth = [0,31,0,31,30,31,30,31,31,30,31,30,31];
          var daysInMonth = daysPerMonth[month];

          if ( day > daysInMonth )
          {
            var monthNames = ["","January","","March","April","May","June","July","August","September","October","November","December"];
            var monthName = monthNames[month];
            displayError("Day is invalid for " + monthName + ". Expected 1-" + daysInMonth );
            return false;
          }
        }

        return true;
      }

      function isValidDesc( desc )
      {
        if ( desc == '' )
        {
          displayError("Description is required.");
          return false;
        }

        return true;
      }

      function displayError( message )
      {
        console.log("ERROR: " + message );

        $("#errorMessages").text( message );
      }

      function clearError()
      {
        $("#errorMessages").contents().remove();
      }

      function onCancelButton()
      {
        hideScheduleForm();
      }

      function onFormSubmit()
      {
        // TODO
        // When in production, return true.
        // When testing with no server, return false.
        return false;
      }

      function buildTable( apps )
      {
        var table = $('<table>').addClass("searchTable");
        var header = $('<tr>');
        var dateHeader = $('<th>').text('DATE');
        var timeHeader = $('<th>').text('Time');
        var descHeader = $('<th>').text('DESCRIPTION');
        header.append(dateHeader).append(timeHeader).append(descHeader);
        table.append(header);

        apps.forEach( function( app, index )
        {
          var row = $("<tr>");
          var date = $("<td>").text(app.date).css("text-align","center");
          var time = $("<td>").text(app.time).css("text-align","right").addClass("pad");
          var desc = $("<td>").text(app.desc);
          row.append(date).append(time).append(desc);
          table.append(row);
        } );

        table.css("width","100%").css("border","1px solid black");
        table.find("th").css("border","1px solid black").css("text-align","left").css("padding","5px");
        table.find("td").css("border","1px solid black").css("padding","5px");
        table.find("td.pad").css("padding","0px 10px 0px 0px");
        dateHeader.css("width","75");
        timeHeader.css("width","75");

        return table;
      }

      function updateTable( apps )
      {
        var table = buildTable( apps );

        $("#appsTable").html(table);
      }

      function handleAjaxError( jqXHR, textStatus, errorThrown )
      {
        displayError("Communication Error: " + textStatus );
      }

      function clearPage()
      {
        clearError();
        $("#appsTable").children().remove();
      }

      function searchAppointments( query )
      {
        clearPage();

        getAppointments( query );
      }

      function getAppointments( query )
      {
        query = query || '';

        clearError();

        // TODO
        // When in production, use "http://localhost:8080/cgi-bin/schedule.pl".
        // When testing with no server, use "schedules.json".
        var url = "schedules.json";

        $.ajax( { url: url,
                  dataType: 'json',
                  data: { getAppointments: query },
                  success: updateTable,
                  error: handleAjaxError } );
      }

      $(document).ready( function()
      {
        initControls();

        getAppointments();
      } );

    </script>

  </body>
</html>
